
# **æœ¬åœ°éƒ¨ç½² CAD å›¾ç‰‡çŸ¢é‡åŒ–æœåŠ¡å™¨**
æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨æœ¬åœ°æ­å»ºä¸€ä¸ª **FastAPI + Celery + Redis** çš„ CAD çŸ¢é‡åŒ–æœåŠ¡å™¨ï¼Œæ”¯æŒè¿œç¨‹è°ƒç”¨å›¾ç‰‡çŸ¢é‡åŒ–ï¼Œå¹¶ä¸‹è½½ DXF ç»“æœã€‚

---

## **ğŸ“Œ 1. ç¯å¢ƒå‡†å¤‡**
### **1.1 å®‰è£…ä¾èµ–**
```bash
pip install fastapi uvicorn opencv-python numpy requests pillow \
    celery redis gunicorn
```
å¦‚æœä½¿ç”¨ **Docker** è¿›è¡Œæµ‹è¯•ï¼š
```bash
# å®‰è£… Dockerï¼ˆLinuxï¼‰
sudo apt install docker.io
# macOS / Windows ä½¿ç”¨ Docker Desktop
```

---

### **1.2 å¯åŠ¨ Redis**
#### **æ–¹æ³• 1ï¼šç›´æ¥è¿è¡Œ Redis**
```bash
# Linux/macOS
redis-server &
# Windows éœ€æ‰‹åŠ¨å®‰è£… Redis for Windows ç‰ˆæœ¬
redis-server.exe
```
#### **æ–¹æ³• 2ï¼šä½¿ç”¨ Docker è¿è¡Œ Redis**
```bash
docker run -d --name redis -p 6379:6379 redis
```

---

## **ğŸ“Œ 2. æœåŠ¡å™¨ç«¯**
åˆ›å»º `server.py` ä½œä¸º FastAPI æœåŠ¡å™¨ï¼š
```python
from fastapi import FastAPI, File, UploadFile
from fastapi.responses import FileResponse
import os
import shutil
from tasks import process_cad_image  # Celery ä»»åŠ¡

app = FastAPI()

UPLOAD_DIR = "uploads"
OUTPUT_DIR = "outputs"
os.makedirs(UPLOAD_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)

@app.post("/upload/")
async def upload_file(file: UploadFile = File(...)):
    file_path = os.path.join(UPLOAD_DIR, file.filename)
    with open(file_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)

    output_dxf = os.path.join(OUTPUT_DIR, file.filename.replace(".png", ".dxf"))

    # å‘é€å¼‚æ­¥ä»»åŠ¡åˆ° Celery
    task = process_cad_image.delay(file_path, output_dxf)

    return {"task_id": task.id, "message": "Processing started"}

@app.get("/task/{task_id}")
async def get_task_status(task_id: str):
    task = process_cad_image.AsyncResult(task_id)
    return {"status": task.status, "result": task.result if task.ready() else "Processing"}

@app.get("/download/{filename}")
async def download_file(filename: str):
    file_path = os.path.join(OUTPUT_DIR, filename)
    return FileResponse(file_path, media_type='application/octet-stream', filename=filename)

if __name__ == '__main__':
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

---

## **ğŸ“Œ 3. ä»»åŠ¡é˜Ÿåˆ—**
åˆ›å»º `tasks.py` å¤„ç† CAD çŸ¢é‡åŒ–ï¼š
```python
from celery import Celery
import time

app = Celery('tasks', broker='redis://localhost:6379/0', backend='redis://localhost:6379/0')

@app.task
def process_cad_image(input_path, output_path):
    print(f"Processing {input_path} -> {output_path}")
    time.sleep(5)  # æ¨¡æ‹Ÿ CAD çŸ¢é‡åŒ–
    with open(output_path, "w") as f:
        f.write("DXF data")  # æ¨¡æ‹Ÿ DXF ç”Ÿæˆ
    return f"Saved {output_path}"
```

---

## **ğŸ“Œ 4. è¿è¡ŒæœåŠ¡å™¨**
### **4.1 å¯åŠ¨ Celery**
```bash
celery -A tasks worker --loglevel=info
```
### **4.2 å¯åŠ¨ FastAPI**
```bash
uvicorn server:app --host 0.0.0.0 --port 8000
```

---

## **ğŸ“Œ 5. å®¢æˆ·ç«¯æµ‹è¯•**
åˆ›å»º `client.py` æ¨¡æ‹Ÿå®¢æˆ·ç«¯ä¸Šä¼ å›¾ç‰‡ï¼š
```python
import requests
import time

# ä¸Šä¼ å›¾ç‰‡
file_path = "test.png"
upload_url = "http://127.0.0.1:8000/upload/"

with open(file_path, "rb") as f:
    response = requests.post(upload_url, files={"file": f})

task_id = response.json()["task_id"]
print(f"Task ID: {task_id}")

# è½®è¯¢ä»»åŠ¡çŠ¶æ€
while True:
    task_status = requests.get(f"http://127.0.0.1:8000/task/{task_id}").json()
    print(f"Task status: {task_status['status']}")
    if task_status["status"] == "SUCCESS":
        break
    time.sleep(2)

# ä¸‹è½½ DXF
download_url = "http://127.0.0.1:8000/download/test.dxf"
response = requests.get(download_url)

with open("test.dxf", "wb") as f:
    f.write(response.content)

print("DXF æ–‡ä»¶å·²ä¸‹è½½ï¼")
```

---

## **ğŸ“Œ 6. æµ‹è¯•æµç¨‹**
1. **å¯åŠ¨ Redis**
```bash
redis-server &
```
2. **è¿è¡Œ Celery**
```bash
celery -A tasks worker --loglevel=info
```
3. **è¿è¡Œ FastAPI**
```bash
uvicorn server:app --host 0.0.0.0 --port 8000
```
4. **è¿è¡Œå®¢æˆ·ç«¯**
```bash
python client.py
```

---

## **ğŸ“Œ 7. ç»“æœ**
âœ… **å®¢æˆ·ç«¯ä¸Šä¼  `test.png`**  
âœ… **æœåŠ¡å™¨å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼ˆCelery è¿è¡Œä¸­ï¼‰**  
âœ… **ä»»åŠ¡å®Œæˆåï¼Œå®¢æˆ·ç«¯ä¸‹è½½ `test.dxf`**  

---

ä½ å¯ä»¥æŠŠè¿™ä»½ Markdown ç›´æ¥ä¿å­˜æˆ `README.md`ï¼Œè¿™æ ·ä½ çš„æœ¬åœ°æµ‹è¯•ç¯å¢ƒå°±å¯ä»¥éšæ—¶å¤ç°äº†ï¼ğŸ¯ğŸš€